<!DOCTYPE html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<style>
  .card-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
  }
  .card {
    border: 1px solid #ccc;
    margin: 10px;
    width: 300px;
    text-align: center;
    overflow: hidden;
    padding: 10px;
    border-radius: 10px;
  }
  .card img {
    max-width: 100%;
    max-height: 200px;
    height: auto;
  }
  .card-content {
    padding: 10px;
    max-height: 100px; /* Adjust the max height as needed */
    overflow: hidden;
  }
  .update-status {
    text-align: left;
  }
</style>
<div id="data-list"></div>
<select id="filtro-campo">
    <option value="nombre">Nombre de persona desaparecida</option>
    <option value="zona">Zona</option>
</select>
<select id="filtro-zona" style="display: none;">
    <option value="">Seleccionar Zona</option>
    <option value="Alta Progreso">Alta Progreso</option>
    <!-- Other options here -->
</select>
<input type="text" id="filtro-entrada" placeholder="Filtrar por nombre o zona"><br>
<button id="filtrar-button">Filtrar</button>
<button id="reporte" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSfqtoS1DvwwcNj56MevuQl002A8lKWvwGci-t7OceWkfydtMA/viewform', '_blank')">Crear Reporte</button>
<div id="filtered-list" class="card-container"></div>


<script>
    var csvFileURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRRo-QOJ6L0_YLK8A5ThIugf6c1AcZE-MGgd_hLuWgRhQKf1HauB3MOEkkfKa7xBMKQwbNGJ9KMWZoI/pub?output=csv"; // Reemplaza con la URL de tu archivo .csv

    function cargarDatos() {
        fetch(csvFileURL)
            .then(function (response) {
                return response.text();
            })
            .then(function (data) {
                Papa.parse(data, {
                    header: true, // Si la primera fila del archivo .csv contiene encabezados de columna
                    complete: function (result) {
                        var dataList = document.getElementById("data-list");
                        var filteredList = document.getElementById("filtered-list");
                        var filtroCampo = document.getElementById("filtro-campo");
                        var filtroEntrada = document.getElementById("filtro-entrada");
                        var filtrarButton = document.getElementById("filtrar-button");
                        var filtroZona = document.getElementById("filtro-zona");


                        function actualizarLista(filtro) {
                            filteredList.innerHTML = "";
                            result.data.forEach(function (item) {
                              var nombre = (item["Nombre persona desaparecida"] || "").trim();
                              var edad = (item["Edad"] || "").trim();
                              var sexo = (item["Sexo"] || "").trim();
                              var rasgos = (item["Rasgos distintivos"] || "").trim();
                              var zona = (item["Zona"] || "").trim();
                              var ultima = (item["Última ubicación conocida"] || "").trim();
                              var estado = (item["Estado de la persona"] || "").trim();
                              var foto = (item["Fotografía"] || "").trim();
                              var numero = (item["Número de teléfono de contacto"] || "").trim();
                          
                              if (
                                (filtroCampo.value === "nombre" && new RegExp(filtro, 'i').test(nombre)) ||
                                (filtroCampo.value === "zona" && new RegExp(filtro, 'i').test(zona))
                              ) {
                                var card = document.createElement("div");
                                card.className = "card";
                          
                                // Transform the Google Drive URL if needed
                                if (foto && foto.includes("drive.google.com/open?id=")) {
                                  foto = transformarURLGoogleDrive(foto);
                                }
                          
                                if (foto) {
                                  var image = document.createElement("img");
                                  image.src = foto;
                                  card.appendChild(image);
                                } else {
                                    var noImage = document.createElement("img");
                                    noImage.src = "avatar.png"
                                    card.appendChild(noImage);
                                }
                          
                                var nombreElement = document.createElement("p");
                                nombreElement.innerHTML = "<strong>Nombre:</strong> <br>" + nombre;
                                card.appendChild(nombreElement);

                                var edadElement = document.createElement("p");
                                edadElement.innerHTML = "<strong>Edad:</strong> <br>" + edad;
                                card.appendChild(edadElement);

                                var sexoElement = document.createElement("p");
                                sexoElement.innerHTML = "<strong>Sexo:</strong> <br>" + sexo;
                                card.appendChild(sexoElement);
                                
                                if (rasgos){
                                    var rasgosElement = document.createElement("p");
                                    rasgosElement.innerHTML = "<strong>Rasgos distintivos:</strong><br> " + rasgos;
                                    card.appendChild(rasgosElement);
                                }
                          
                                var zonaElement = document.createElement("p");
                                zonaElement.innerHTML = "<strong>Zona:</strong><br> " + zona;
                                card.appendChild(zonaElement);

                                if (ultima){
                                    var ultimaElement = document.createElement("p");
                                    ultimaElement.innerHTML = "<strong>Última ubicación conocida:</strong><br> " + ultima;
                                    card.appendChild(ultimaElement);
                                }

                                var estadoElement = document.createElement("p");
                                estadoElement.innerHTML = "<strong>Estado:</strong><br> " + estado;
                                card.appendChild(estadoElement);

                                var numeroElement = document.createElement("p");
                                numeroElement.innerHTML = "<strong>En caso de localizar, contactar al número:</strong><br> " + numero;
                                card.appendChild(numeroElement);
                          
                                filteredList.appendChild(card);
                          
                              }
                            });
                          }
                          
                        filtrarButton.addEventListener("click", function () {
                            if (filtroCampo.value === "nombre") {
                              var filtro = filtroEntrada.value;
                              actualizarLista(filtro);
                            } else if (filtroCampo.value === "zona") {
                              var filtro = filtroZona.value;
                              actualizarLista(filtro);
                            }
                        });

                            // Detect changes in the filtering method
                        filtroCampo.addEventListener("change", function () {
                            if (filtroCampo.value === "zona") {
                                // If Zona is selected, show the Zona selector
                                filtroZona.style.display = "block";
                                filtroEntrada.style.display = "none";
                                filtroEntrada.value = "";
                                var filtro = filtroZona.value;
                                actualizarLista(filtro);
                            } else {
                                // Otherwise, hide the Zona selector
                                filtroZona.style.display = "none";
                                filtroEntrada.style.display = "block";
                                filtroEntrada.value = "";
                                var filtro = filtroEntrada.value;
                                actualizarLista(filtro);
                            }
                        });

                    // Mostrar todos los datos al cargar la página
                    actualizarLista("");
                    },
                });
            });
    }

    // Función para transformar la URL de Google Drive
    function transformarURLGoogleDrive(url) {
        var regex = /https:\/\/drive\.google\.com\/open\?id=([a-zA-Z0-9_-]+)/;
        return url.replace(regex, "https://drive.google.com/uc?export=view&id=$1");
    }

    cargarDatos();
</script>
